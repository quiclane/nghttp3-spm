name: build
on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 */5 * *"
permissions:
  contents: write
jobs:
  build:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: brew update && brew install cmake ninja
      - id: vars
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          git fetch --tags origin
          LAST="$(git tag -l '1.0.*' | sort -V | tail -n 1)"
          if [ -z "$LAST" ];then TAG="1.0.0";else P="$(printf '%s' "$LAST" | sed -E 's/^1\.0\.([0-9]+)$/\1/')";[ "$P" = "$LAST" ]&&P=0;TAG="1.0.$((P+1))";fi
          echo "tag=$TAG" >>"$GITHUB_OUTPUT"
      - run: scripts/nghttp3-ios-xc.sh
      - run: ditto -c -k --sequesterRsrc --keepParent NGHTTP3.xcframework NGHTTP3.xcframework.zip
      - id: meta
        run: |
          set -euo pipefail
          SHA="$(cat UPSTREAM_SHA)"
          IOSNAME="ios-$(date +%Y%m%d)-$SHA"
          CS="$(swift package compute-checksum NGHTTP3.xcframework.zip)"
          URL="https://github.com/quiclane/nghttp3-spm/releases/download/${{ steps.vars.outputs.tag }}/NGHTTP3.xcframework.zip"
          echo "sha=$SHA" >>"$GITHUB_OUTPUT"
          echo "iosname=$IOSNAME" >>"$GITHUB_OUTPUT"
          echo "cs=$CS" >>"$GITHUB_OUTPUT"
          echo "url=$URL" >>"$GITHUB_OUTPUT"
      - env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          git config user.name github-actions
          git config user.email github-actions@github.com
          git fetch origin main
          git reset --hard origin/main
          git clean -fdx
          printf '%s\n' '// swift-tools-version:6.0' 'import PackageDescription' "let package=Package(name:\"NGHTTP3\",platforms:[.iOS(.v13)],products:[.library(name:\"NGHTTP3\",targets:[\"NGHTTP3\"])],targets:[.binaryTarget(name:\"NGHTTP3\",url:\"${{ steps.meta.outputs.url }}\",checksum:\"${{ steps.meta.outputs.cs }}\")])" >Package.swift
          git add Package.swift
          git commit -m "update Package.swift to ${{ steps.vars.outputs.tag }}" || true
          git push
          git tag "${{ steps.vars.outputs.tag }}"
          git push origin "${{ steps.vars.outputs.tag }}"
      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: ${{ steps.meta.outputs.iosname }}
          body: |
            upstream_commit=${{ steps.meta.outputs.sha }}
            swiftpm_checksum=${{ steps.meta.outputs.cs }}
          files: NGHTTP3.xcframework.zip
      - env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          RELS="$(gh release list --limit 200 --json tagName,createdAt -q 'sort_by(.createdAt)|reverse|.[].tagName')"
          i=0
          for t in $RELS;do i=$((i+1));[ "$i" -gt 2 ]&&gh release delete "$t" -y||true;done
          git fetch --tags origin
          KEEP="$(git tag -l '1.0.*' | sort -V | tail -n 2 | tr '\n' ' ' | sed 's/[[:space:]]*$//')"
          for t in $(git tag -l '1.0.*' | sort -V);do printf '%s\n' "$KEEP" | tr ' ' '\n' | grep -qx "$t" && continue;git push origin ":refs/tags/$t"||true;git tag -d "$t"||true;done

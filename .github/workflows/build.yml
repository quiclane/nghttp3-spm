name: build
on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 */5 * *"
permissions:
  contents: write
jobs:
  build:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: brew update && brew install cmake ninja
      - run: scripts/nghttp3-ios-xc.sh
      - run: ditto -c -k --sequesterRsrc --keepParent NGHTTP3.xcframework NGHTTP3.xcframework.zip
      - id: vars
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          SHA="$(cat UPSTREAM_SHA)"
          IOSNAME="ios-$(date +%Y%m%d)-$SHA"
          CHECKSUM="$(swift package compute-checksum NGHTTP3.xcframework.zip)"
          git fetch --tags origin
          LAST="$(git tag -l '1.0.*' | sort -V | tail -n 1)"
          if [ -z "$LAST" ];then TAG="1.0.0";else
            P="$(printf '%s' "$LAST" | sed -E 's/^1\.0\.([0-9]+)$/\1/')"
            if [ "$P" = "$LAST" ];then P=0;fi
            TAG="1.0.$((P+1))"
          fi
          echo "sha=$SHA" >>"$GITHUB_OUTPUT"
          echo "iosname=$IOSNAME" >>"$GITHUB_OUTPUT"
          echo "tag=$TAG" >>"$GITHUB_OUTPUT"
          echo "checksum=$CHECKSUM" >>"$GITHUB_OUTPUT"
      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: ${{ steps.vars.outputs.iosname }}
          body: |
            upstream_commit=${{ steps.vars.outputs.sha }}
            swiftpm_checksum=${{ steps.vars.outputs.checksum }}
          files: NGHTTP3.xcframework.zip
      - id: asset
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          ASSET_URL="$(gh release view "${{ steps.vars.outputs.tag }}" --json assets -q '.assets[]|select(.name=="NGHTTP3.xcframework.zip")|.url')"
          echo "asset_url=$ASSET_URL" >>"$GITHUB_OUTPUT"
      - env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          git config user.name github-actions
          git config user.email github-actions@github.com
          for n in 1 2 3 4 5;do
            git fetch origin main
            git reset --hard origin/main
            git clean -fdx
            printf '%s\n' '// swift-tools-version:6.0' 'import PackageDescription' "let package=Package(name:\"NGHTTP3\",platforms:[.iOS(.v13)],products:[.library(name:\"NGHTTP3\",targets:[\"NGHTTP3\"])],targets:[.binaryTarget(name:\"NGHTTP3\",url:\"${{ steps.asset.outputs.asset_url }}\",checksum:\"${{ steps.vars.outputs.checksum }}\")])" >Package.swift
            git add Package.swift
            git commit -m "update Package.swift to ${{ steps.vars.outputs.tag }}" || true
            git push && break || true
            sleep 2
          done
      - env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          RELS="$(gh release list --limit 200 --json tagName,createdAt -q 'sort_by(.createdAt)|reverse|.[].tagName')"
          i=0
          for t in $RELS;do
            i=$((i+1))
            if [ "$i" -gt 2 ];then gh release delete "$t" -y;fi
          done
          git fetch --tags origin
          KEEP="$(git tag -l '1.0.*' | sort -V | tail -n 2 | tr '\n' ' ' | sed 's/[[:space:]]*$//')"
          ALL="$(git tag -l '1.0.*' | sort -V)"
          for t in $ALL;do
            printf '%s\n' "$KEEP" | tr ' ' '\n' | grep -qx "$t" && continue
            git push origin ":refs/tags/$t" || true
            git tag -d "$t" || true
          done
